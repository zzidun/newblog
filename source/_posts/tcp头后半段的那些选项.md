---
title: tcp头后半段的那些选项
categories:
  - 学习和理论
tags:
  - tcp
  - 计算机网络
abbrlink: ad7e6196
date: 2022-01-04 16:27:02
---

* EOL & NOP;
* MSS;
* WSOPT;
* SACK;

<!-- more -->

## 前言

众所周知,TCP的头部有一个字段`Data offset`,表示数据从哪个位置开始.

也就是说在`offset`之前的信息,都是tcp的头部及其填充(因为`offset`的单位是4字节,头部大小不为4字节的倍数时需要填充到4字节的倍数).

这个`offset`有4位,可以表达0-15的大小,也就是头的长度最多是60.

前20个字节都已经确定.后面40个字节可以放置TL结构的选项.

| type | length | value |
| --- | --- | --- |
| 1 byte | 1 byte | length byte |

我很长一段时间里面都无视了这个东西的作用,今天心血来潮想要了解和整理一下.

主要选项有

| type | length | 简称 | 描述 |
| --- | --- | --- | --- |
| 0 | 1 | EOL | 选项列表结束 |
| 1 | 1 | NOP | 无操作 |
| 2 | 4 | MSS | 最大Segmegnt长度 |
| 3 | 3 | WSOPT | 窗口扩大系数 |
| 4 | 2 | SACK-Permitted | 表示支持SACK |
| 5 | mutable | SACK | 确认区间 |
| 8 | 10 | TSOPT | Timestamps |
| 19 | 18 | TCP-MD5 | MD5认证 |
| 28 | mutable | UTO | 超过一定时间后拆除连接 |

## EOL和NOP


这里的`length`,是包括`type`和`lenght`本身的长度的.

也就是如果`length`为`4`,那么留给`value`的空间只有`2`字节了.

那么只有一个字节长度的`EOL`和`NOP`,是什么情况?

他们是把`length`字段也省略了,只有一个`type`.

`EOL`的作用是放在tcp头的最后一个选项后面,以表示选项已经结束.

那么就会有人疑问,直接根据tcp头的长度字段来指出结束位置不就好了吗,为什么还需要一个`EOL`.

那是因为tcp头不一定刚好在`4`字节的整数倍的位置结束,在这种情况下需要一个`EOL`来表示后续数据都是填充的`0`.

如果tcp头的长度刚好为4字节的倍数,那么就不需要EOL.


`NOP`则是可以用在选项之间或结尾的填充位,比如`WSOPT`选项长度为`3`,有的机器可能会补一个`NOP`来让他`4`字节对齐.

## MSS

| type | length | value |
| --- | --- | --- |
| 0x02 | 0x04 | 长度 |

Maximum segment size(MSS)是TCP期望从对端接收的最大的报文长度，自然也是对端在发送报文的时候的最大报文长度，注意MSS值仅指示TCP数据长度，并不包含关联的TCP头和IP头的长度。当连接在建立的时候，每个endpoint通常会在对应的SYN包中通过MSS option通告对方自己的MSS，按照RFC1122规定如果没有MSS选项提供则会使用默认的536bytes作为MSS(注意原始的RFC793协议是说没有提供MSS选项的时候可以发送任意大小的包，RFC1122修正了该说法)。还有一点需要注意由于目前网卡普遍支持TSO、GSO功能，在开启这些功能的前提下，协议栈中的TCP层可能会按照MSS的整数倍发包，然后再由网卡硬件来对TCP分段，这样减轻了CPU的处理压力。后面为了方便讨论窗口管理等特性，我们还是按照TCP层最大包不超过MSS来讨论。

在IPV6的jumbogram中(RFC2675)，如果接收端接收到的MSS值为65535时候，标识真实的MSS需要根据PMTU值来确定。即MSS=PMTU-60。(jumbogram是IPV6中一种发送超大IP报文的协议特性，PMTU是接收端和发送端链路之间所有设备的最小MTU。)

RFC6691重新澄清了MSS选项的相关说明，并修正了之前几个RFC的错误说法。RFC6691明确规定在MSS选项中传递的MSS值为MTU减去IP基本头(ipv4为20bytes，IPV6为40bytes)和TCP基本头(20bytes)的值，不考虑扩展头。发送端负责发送数据前在这个MSS值的基础上扣除扩展头长度得出真实传输数据的长度。

## WSOPT

| type | length | value |
| --- | --- | --- |
| 0x03 | 0x03 | 位移量 |

在SYN和SYN-ACK中传输,当SYN报文表示可以支持时,SYN-ACK报文就可以发送这个选项.

在tcp头中,窗口大小是一个`16`位数字.

但是在系统中,保存窗口大小用的是一个`32`位数字.

如果在选项中加上这个偏移(最大为`14`,大于`14`时当作`14`处理),那么可以使用的窗口的大小能够扩展成`30`位数字.

只能设置成不大于`14`,是为了避免真的用上了整个`32`位的空间,导致所有序号都在窗口内.

tcp通过判断序列号是否在`第一个未确认序列号 -- 第一个未确认序列号+2^31`的范围内,来判断序列号是否是新序列号.

当窗口过大时将会出错.

## SACK

有时候接收方会收到几段不连续的数据(他们的编号不连续),这时候可以发送几个区间,告诉发送方自己收到了哪几段数据.

`SACK-permiited`在带有SYN标志的包中传输,表示双方是否支持`SACK`.

| type | length | value |
| --- | --- | --- |
| 0x04 | 0x02 | 支持与否 |

`SACK`包含若干个区间的描述信息,表示已经收到了哪几个区间内的数据.

区间的起止都是一个`4`字节的数字.也就是表示一个区间需要用到`8`字节.

由于选项字段最多只有`40`字节的空间,所以顶多有`4`个区间

| type | length | value |
| --- | --- | --- |
| 0x05 | mutable | 区间信息 |

未完待续