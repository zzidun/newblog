---
title: 各类总线协议总结
categories:
  - 经验和总结
tags:
  - UART
  - IIC
  - SPI
  - RS232
mathjax: true
abbrlink: c2cf85d2
date: 2022-01-09 14:22:53
---

* UART;
* IIC;
* SPI;
* RS232;
* RS485;

<!-- more -->

## UART(通用异步收发器)

### 简介

`UART`总线有两条线,一条接收`RXD`,一条发送`TXD`.

连接时两个设备交叉连接,甲的`RXD`连乙的`TXD`.

### 帧格式

一次只能发送一个字节,如果需要发送多个字节需要发送多次.

| 起始位 | 数据位 | 校验位 | 停止位 |
| --- | --- | --- | --- |
| `1`个`0` | `5`到`8`位,先发低位 | `1`位 | `1~2`个`1` |

从空闲状态发送一个字节的过程

首先发送一个起始位`0`,然后发送数据和校验位,最后停止位`1`.

停止位可以是`1` `1.5`或`2`位,这是因为发送一个字节之后可能会发送一点不同步,停止位可以让他们校准.

停止位越长,对不同步的容忍越大,但是速率也越慢.

## IIC

### 简介

`IIC`有两根线,一根时钟线`SCL`,一根数据线`SDA`.

`IIC`总线上的器件有一个`7`位的唯一地址,每个器件都可以作为主机和从机.

主机有权发起和结束一次通信,而从机只能被主机呼叫.

### 通信过程

{% mermaid %}
graph TD
    A[1:主机发送起始信号启用总线] --> B[2:主机发送一个字节数据,指明从机地址和后续字节的传送方向]
    B --> C[3:被寻址的从机发送应答信号]
    C --> E[4:发送器发送一个字节数据]
    E --> F[5:接收器回应发送信号]
    F --后续还有数据--> E[6:发送器发送一个字节数据]
    F --发送完毕--> G[7:通信完成后主机发送停止信号释放总线]
{% endmermaid %}

需要注意,发送和接送的过程中,不一定是主机发送从机接受.

具体接受发送方向由步骤`2`确定.

所以我们这里只能称呼发送方为发送器,接收方为接收器.

对于数据的传输过程

### 帧格式

1. 起始信号和结束信号

当`SCL`处于高电平时,`SDA`从高变低表示起始信号.

当`SCL`位于高电平时,`SDA`从低变高表示停止信号.

2. 地址

| 7位地址 | 1位方向位 |
| --- | --- |
| 表示从机地址 | `0`表示主机发往从机,`1`表示从机发往主机 |

3. 数据

| 数据位 | 应答位 |
| --- | --- |
| `8`数据,也就是`1`个字节,先发送高位,再发送低位 | 接收器发送`1`位应答位,$ A $是应答, $ \bar{A} $是非应答|

发送数据时,电平如下变化:

当`SCL`处于低电平时,`SDA`变化,这时候发送器向`SDA`发送`1`位数据.

当`SCL`处于高电平时,`SDA`不变化,这时候接收器从`SDA`读取`1`位数据.

相当于发送器在时钟线低电平的时候放进数据,接收器在始终线高电平的时候接收数据.

把收发时机这样确定下来,就不会发送接收器还没读,发送器就放下一个数据之类的问题.

## SPI

### 简介

`SPI`总线至少需要`4`条线.

| 主机 | 从机 | 作用 | 
| --- | --- | --- |
| `SCLK` | `SCLK` | 时钟线 |
| `MOSI` | `MOSI` | 主机输出,从机输入 |
| `MISO` | `MISO` | 主机输入,从机输出 |
| `CS` | `CS` | 使能 |

当一个主机要对应多个从机的时候,主机上需要多条`CS`线,来进行寻址.

多个从机的`SCLK`,都是连接到主机的同一个`SCLK`上的.

多个从机的`MOSI`,都是连接到主机的同一个`MOSI`上的.

多个从机的`MISO`,都是连接到主机的同一个`MISO`上的.

但是为了寻址从机,每个从机都需要对应主机上的一个单独的`CS`,来分别使要使用的从机使能.

因此主机上可能不止有`4`条线.

### 通信过程

对于一个字节,先传高位,后传地位.

在时钟的边沿发送数据,在时钟的下一个边沿读取数据.

### 极性(CPOL)和相位(CPHL)

`CPOL`为`0`,表示空闲时`SCLK`为低电平.

`CPOL`为`1`,表示空闲时`SCLK`位高电平.

`CPHA`为`0`,表示每个周期的第一个时钟沿采样.

`CPHA`为`1`,表示每个周期的第二个时钟沿采样.

## RS232/RS485

`UART`只是定义了时序,没有定义接口的电气特性.

`UART`通信一般直接使用处理器的电平,`TTL`电平.抗干扰能力差.传输距离短.

`UART`没有定义连接器的标准,需要自己探索各线的定义.

### RS232

`RS232`提出了一个标准的连接器,定义了各个引脚作用,规定了电平.

最开始他有`25`线,后来变成`9`线,大多使用的只有`GND`,`RXD`,`TXD`.

信号`1`为`-5v`到`-15v`.

信号`0`为`5v`到`15v`.

传输距离可达`15m`.

### RS485

`RS485`用两线的电压差表示数据.

相差`+2v`到`+6v`为`1`.

相差`-2v`到`-6v`为`0`.

在这种情况下,总线上可以存在多个设备,使用半双工通信.

传输距离达到`1500m`